services:
  # ONE IMAGE - Frontend + Convex Backend all in one!
  app:
    platform: linux/amd64  # Convex backend requires amd64 (uses QEMU emulation on ARM Macs)
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        APP_URL: ${APP_URL:-http://localhost}
        API_PORT: ${API_PORT:-3210}
        TARGETPLATFORM: linux/amd64  # Convex backend requires amd64
    image: ${DOCKER_IMAGE:-ekkolyth/ekklipse}:${DOCKER_TAG:-dev}
    container_name: ekklipse
    ports:
      - "${WEB_PORT:-3000}:3000"  # Frontend
      - "${API_PORT:-3210}:3210"  # Convex Backend API
    volumes:
      - convex-data:/convex/data
    environment:
      - INSTANCE_NAME=convex-self-hosted
    restart: unless-stopped

volumes:
  convex-data:
    driver: local
